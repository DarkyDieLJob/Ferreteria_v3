<!-- tabla_lateral_carritos.html -->

<style>
    @media (max-width: 768px) {
        #tablaCarrito {
            width: 95% !important;
        }
    }
    /* Loading indicator style */
    .loading-indicator {
        display: none;
        position: fixed;
        top: 10px;
        right: 10px;
        background: #ffc107;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        z-index: 1000;
    }
</style>

<!-- Loading indicator -->
<div id="cartLoading" class="loading-indicator">Actualizando carrito...</div>

<div id="tablaCarrito" class="position-fixed top-0 end-0" style="width: 50%; height: 100%; overflow: auto; display: none; background-color: white; z-index: 1050;">
    
<div class="p-3">
    <div class='row'>
        <button id="cerrarCarrito" class="btn btn-secondary">Cerrar</button>
    </div>
</div>

<!-- Rest of your existing HTML remains unchanged -->
<div class="p-3">
    <div class="card">
        <!-- Aqui un form -->
        <form id="formTransaccion" method="post">
            <input type="hidden" id="usuario" name="usuario" value="">
            <input type="hidden" id="carrito_id" name="carrito_id" value="">
            <input type="hidden" id="articulos_vendidos" name="articulos_vendidos" value="">
            <select id="cliente_id" name="cliente_id" required>
                <option value="">-------</option>
            </select>
            <input type="text" id="buscar_cliente" placeholder="Buscar cliente">
            <select id="metodo_de_pago" name="metodo_de_pago"></select>
            <input type="hidden" id="total" name="total" value="">
            <input type="hidden" id="total_efectivo" name="total_efectivo" value="">
            <button id="enviar-transaccion"  type="submit" class="btn btn-primary">Cerrar Transacción</button>
            <button type="button" class="btn btn-secondary" id="nuevoCliente"> + Cliente</button>
        </form>
    </div>
</div>

<div class="modal fade" id="modalNuevoCliente" tabindex="-1" role="dialog" aria-labelledby="modalNuevoClienteLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoClienteLabel">Nuevo Cliente</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="formNuevoCliente" method="post">
            <input type="text" id="razon_social" name="razon_social" placeholder="Razón Social">
            <input type="text" id="cuit_dni" name="cuit_dni" placeholder="CUIT/DNI">
            <button type="submit" class="btn btn-primary">Guardar</button>
          </form>
        </div>
      </div>
    </div>
</div>

<div class="p-3">
    <div class="card">
        <form id="formArticuloSinRegistro" method="post">
            <div class= "row p-0 m-0">
                <input type="text" id="descripcion" name="descripcion" placeholder="Descripción" value="Generico" required>
            </div>
            <div class= "colum p-0 m-0">
                <input type="number" id="cantidad" name="cantidad" placeholder="Cantidad" step="0.01" value="1" required>
                <input type="number" id="precio" name="precio" placeholder="Precio" step="0.01" value="" required>
                <button type="submit" class="btn btn-primary">Agregar Artículo</button>
            </div>
        </form>
    </div>
</div>

<div class="p-3">
    <div class="card">
        <table id="tabla-articulos" class="table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Borrar</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se llenará la tabla con los datos del carrito -->
            </tbody>
        </table>
    </div>
</div>

</div>

<script>
// Variables globales para el control de actualización
let cartUpdateInterval = null;
const CART_UPDATE_INTERVAL = 3000; // 3 segundos
let isUpdatingCart = false;
let lastCartData = null;

// Función para mostrar/ocultar el indicador de carga
function toggleLoadingIndicator(show) {
    const indicator = document.getElementById('cartLoading');
    if (indicator) {
        indicator.style.display = show ? 'block' : 'none';
    }
}

// Función para iniciar la actualización automática
function startCartAutoUpdate() {
    // Detener cualquier intervalo existente
    stopCartAutoUpdate();
    
    // Iniciar nuevo intervalo
    cartUpdateInterval = setInterval(updateCartIfVisible, CART_UPDATE_INTERVAL);
    console.log('Iniciando actualización automática del carrito');
}

// Función para detener la actualización automática
function stopCartAutoUpdate() {
    if (cartUpdateInterval) {
        clearInterval(cartUpdateInterval);
        cartUpdateInterval = null;
        console.log('Detenida actualización automática del carrito');
    }
}

// Función para actualizar el carrito si está visible
function updateCartIfVisible() {
    // Solo actualizar si la pestaña está activa y el carrito está visible
    if (document.visibilityState === 'visible' && $("#tablaCarrito").is(":visible")) {
        const currentCartName = $("#tablaCarrito").data("nombre");
        if (currentCartName && !isUpdatingCart) {
            updateCart(currentCartName);
        }
    }
}

// Función para actualizar el carrito
function updateCart(nombre) {
    if (isUpdatingCart) return;
    
    isUpdatingCart = true;
    toggleLoadingIndicator(true);
    
    $.ajax({
        url: '/consultar_carrito/',
        type: 'get',
        dataType: 'json',
        success: function(data) {
            // Verificar si hay cambios antes de actualizar
            const currentData = JSON.stringify(data);
            if (lastCartData !== currentData) {
                lastCartData = currentData;
                llenarCarrito(nombre);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error al actualizar el carrito:', error);
            // Reintentar después de un tiempo en caso de error
            setTimeout(() => isUpdatingCart = false, 5000);
        },
        complete: function() {
            toggleLoadingIndicator(false);
            isUpdatingCart = false;
        }
    });
}

// Resto de tu código JavaScript existente...
document.getElementById('enviar-transaccion').addEventListener('click', function(event) {
    const tablaArticulos = document.getElementById('tabla-articulos');
    console.log(tablaArticulos.rows.length)
    if (tablaArticulos.rows.length < 4 ) {
        event.preventDefault();
        alert('No hay artículos en el carrito. Agrega al menos uno antes de enviar la transacción.');
    }
});

document.getElementById('nuevoCliente').onclick = function () {
    window.location.href = "/facturacion/clientes/";
};

$(document).ready(function(){
    // Iniciar la actualización automática
    startCartAutoUpdate();
    
    // Manejar cambios en la visibilidad de la pestaña
    $(document).on('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // Actualizar inmediatamente al volver a la pestaña
            const currentCartName = $("#tablaCarrito").data("nombre");
            if (currentCartName) {
                updateCart(currentCartName);
            }
            startCartAutoUpdate();
        } else {
            stopCartAutoUpdate();
        }
    });

    // Resto de tu código document.ready existente...
    $.ajax({
        url: '/obtener_cliente/',
        type: 'get',
        dataType: 'json',
        success: function(data) {
            var select = $("#cliente_id");
            data.clientes.forEach(function(cliente) {
                select.append('<option value="' + cliente.id + '">' + cliente.razon_social + ' (' + cliente.cuit_dni + ')' + '</option>');
            });
        }
    });
    
    // Resto de tu código JavaScript existente...
    $("#buscar_cliente").prop("disabled", true);
    $("#cliente_id").prop("disabled", true);

    $("#buscar_cliente").on('input', function() {
        var buscar = $(this).val().toLowerCase();
        $("#cliente_id option").each(function() {
            var texto = $(this).text().toLowerCase();
            $(this).toggle(texto.indexOf(buscar) > -1);
        });
    });

    $("#metodo_de_pago").change(function() {
        var metodoDePagoSeleccionado = $(this).val();
        if (metodoDePagoSeleccionado === '1') {
            $("#buscar_cliente").prop("disabled", true);
            $("#cliente_id").prop("disabled", true);
            $("#cliente_id").val("");
        } else {
            $("#buscar_cliente").prop("disabled", false);
            $("#cliente_id").prop("disabled", false);
        }
    });
    
    // Modificar la función mostrarCarrito para manejar la actualización automática
    window.mostrarCarrito = function(nombre) {
        if ($("#tablaCarrito").is(":visible")) {
            if ($("#tablaCarrito").data("nombre") !== nombre) {
                llenarCarrito(nombre);
            }
        } else {
            $("#tablaCarrito").show();
            llenarCarrito(nombre);
            // Forzar una actualización inmediata al mostrar el carrito
            updateCart(nombre);
        }
    };

    // Modificar llenarCarrito para actualizar lastCartData
    window.llenarCarrito = function(nombre) {
        toggleLoadingIndicator(true);
        return $.ajax({
            url: '/consultar_carrito/',
            type: 'get',
            dataType: 'json',
            success: function(data) {
                lastCartData = JSON.stringify(data); // Actualizar los datos del carrito
                var tbody = $("#tablaCarrito table tbody");
                tbody.empty();
                
                data[nombre].articulos.forEach(function(item) {
                    tbody.append('<tr><td>' + item.item + '</td><td><input type="number" class="cantidad-articulo" data-id="' + item.id + '" data-tipo="registrado" value="' + item.cantidad + '" style="width: 50px;"></td><td>' + item.precio + '</td><td><button class="btn btn-danger eliminar-articulo" data-id="' + item.id + '" data-tipo="registrado">X</button></td></tr>');
                });
                
                data[nombre].articulos_sin_registro.forEach(function(item) {
                    tbody.append('<tr><td>' + item.descripcion + '</td><td><input type="number" class="cantidad-articulo" data-id="' + item.id + '" data-tipo="no-registrado" value="' + item.cantidad + '" style="width: 50px;"></td><td>' + item.precio + '</td><td><button class="btn btn-danger eliminar-articulo" data-id="' + item.id + '" data-tipo="no-registrado">X</button></td></tr>');
                });
                
                tbody.append('<tr><td>Total</td><td></td><td>' + data[nombre].total + '</td><td></td></tr>');
                tbody.append('<tr><td>Total Efectivo</td><td></td><td>' + data[nombre].total_efectivo + '</td><td></td></tr>');
                
                $("#tablaCarrito").data("nombre", nombre);
                $("#carrito_id").val(data[nombre].carrito_id);
                cambiarColorFondoCarrito(data[nombre].carrito_id);
                $("#cliente_id").val("");

                // Actualizar métodos de pago
                $.ajax({
                    url: '/obtener_metodos_pago/',
                    type: 'get',
                    dataType: 'json',
                    success: function(metodos_pago) {
                        var select = $("#metodo_de_pago");
                        var currentValue = select.val();
                        select.empty();
                        metodos_pago.forEach(function(metodo_pago) {
                            select.append('<option value="' + metodo_pago.id + '">' + metodo_pago.display + '</option>');
                        });
                        // Restaurar el valor seleccionado si existe
                        if (currentValue) {
                            select.val(currentValue);
                        }
                    }
                });
            },
            complete: function() {
                toggleLoadingIndicator(false);
            }
        });
    };
    
    // Resto de tus funciones existentes...
    function cambiarColorFondoCarrito(carrito_id) {
        const coloresCarritos = {
            1: "lightyellow",
            2: "lightgreen",
            3: "lightblue",
        };
        const color = coloresCarritos[carrito_id] || "white";
        $("#tablaCarrito").css("background-color", color);
    }
    
    $(document).on('change', '.cantidad-articulo', function() {
        var id = $(this).attr('data-id');
        var tipo = $(this).attr('data-tipo');
        var cantidad = $(this).val();
        var url = tipo === 'registrado' ? '/actualizar_cantidad_articulo/' : '/actualizar_cantidad_articulo_sin_registro/';
        
        $.ajax({
            url: url,
            type: 'post',
            data: JSON.stringify({
                'id': id,
                'cantidad': cantidad
            }),
            contentType: "application/json",
            success: function(data) {
                updateCart($("#tablaCarrito").data("nombre"));
            }
        });
    });
    
    $(document).on('click', '.eliminar-articulo', function() {
        var id = $(this).attr('data-id');
        var tipo = $(this).attr('data-tipo');
        var url = tipo === 'registrado' ? '/eliminar_articulo/' : '/eliminar_articulo_sin_registro/';
        
        $.ajax({
            url: url,
            type: 'post',
            data: JSON.stringify({
                'id': id
            }),
            contentType: "application/json",
            success: function(data) {
                updateCart($("#tablaCarrito").data("nombre"));
            }
        });
    });
    
    function getColorPorCarritoId(carrito_id) {
        const coloresCarritos = {
            1: "lightyellow",
            2: "lightgreen",
            3: "lightblue",
        };
        return coloresCarritos[carrito_id] || "white";
    }
    
    function crearControlador(nombre) {
        return function() {
            mostrarCarrito(nombre);
        };
    }

    // Inicialización de botones de carrito
    $.ajax({
        url: '/consultar_carrito/',
        type: 'get',
        dataType: 'json',
        success: function(data) {
            console.log(data);
            for (var nombre in data) {
                let carrito_id = data[nombre].carrito_id;
                let color = getColorPorCarritoId(carrito_id);
                console.log(color);
                $("#botonesCarrito").append('<button id="botonCarrito' + nombre + '" class="btn" style="background-color:' + color + ';">Carrito de ' + nombre + '</button>');
                $("#botonCarrito" + nombre).click(crearControlador(nombre));
            }
        }
    });

    // Controlador para el botón de cerrar
    $("#cerrarCarrito").click(function() {
        $("#tablaCarrito").hide();
    });

    // Manejo del formulario de transacción
    $("#formTransaccion").submit(function(e) {
        e.preventDefault();
        var nombre = $("#tablaCarrito").data("nombre");
        
        $.ajax({
            url: '/consultar_carrito/',
            type: 'get',
            dataType: 'json',
            success: function(data) {
                $("#usuario").val(nombre);
                $("#carrito_id").val(data[nombre].carrito_id);
                $("#articulos_vendidos").val(JSON.stringify(data[nombre].articulos));
                $("#cliente_id").val();
                $("#total").val(data[nombre].total);
                $("#total_efectivo").val(data[nombre].total_efectivo);

                console.log(data[nombre].total);
                console.log(data[nombre].total_efectivo);
                console.log($("#formTransaccion").serialize());
                
                $.ajax({
                    url: '/procesar_transaccion/',
                    type: 'post',
                    data: $("#formTransaccion").serialize(),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                        $("#formTransaccion :input").prop("disabled", true);
                    },
                    success: function(response) {
                        $("#formTransaccion").trigger("reset");
                        $("#formArticuloSinRegistro").trigger("reset");
                        $("table tbody").empty();
                        $("#formTransaccion :input").prop("disabled", false);
                        $("#buscar_cliente").prop("disabled", true);
                        $("#cliente_id").prop("disabled", true);
                        $("#cliente_id").val("");
                    }
                });
            }
        });
    });

    // Manejo del formulario de artículos sin registro
    $("#formArticuloSinRegistro").on("submit", function(e) {
        console.log('submit sin registros...');
        e.preventDefault();
        var descripcion = $("#descripcion").val();
        var cantidad = $("#cantidad").val();
        var precio = $("#precio").val();
        var carrito_id = $("#carrito_id").val();
        
        console.log('variables seteadas...');
        $.ajax({
            url: '/agregar_articulo_sin_registro/',
            type: 'post',
            data: JSON.stringify({
                'descripcion': descripcion,
                'cantidad': cantidad,
                'precio': precio,
                'carrito_id': carrito_id
            }),
            contentType: "application/json",
            success: function(data) {
                console.log('datos a /agregar_articulo_sin_registro/');
                console.log(data);
                updateCart($("#tablaCarrito").data("nombre"));
                console.log('tabla rellenada...');
                $("#formArticuloSinRegistro").trigger("reset");
            }
        });
    });

    // Función para obtener cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// Inicializar la actualización automática cuando el documento esté listo
$(document).ready(function() {
    startCartAutoUpdate();
});
</script>